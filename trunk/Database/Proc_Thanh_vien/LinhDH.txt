-- 1. Ý nghĩa: Procedure này dùng để cập nhật lại số dư và số dư khả dụng của trái phiếu
-- 2. Inputs: 
--   + @date: ngày cập nhật
--   + @ip_dc_trai_chu_id: id trái chủ (sẽ suy ra được id trái phiếu) cập nhật số dư trái phiếu
--   + @add_value_tong_so_du: Tổng số dư cập nhật. Nếu mà tổng số dư giảm thì số này là âm
--   + @add_value_so_du_kha_dung: Tổng số dư khả dụng cập nhật. Nếu mà số dư khả dụng giảm thì số này là âm
-- Trong trường hợp số dư khả dụng không đổi mà tổng số dư thay đổi 
-- thì số dư khả dụng sẽ thay đổi theo Tổng số dư

ALTER PROCEDURE [dbo].[pr_GD_SO_DU_TRAI_PHIEU_add_so_du]
  @date datetime
, @ip_dc_trai_chu_id numeric(18,0)
, @add_value_tong_so_du numeric(18,3)
, @add_value_so_du_kha_dung numeric(18,3)
AS
-- Biến này lưu trữ giá trị đúng (=1)or sai(=0): ngày cập nhật số lượng đã tồn tại hay chưa?
declare @v_is_exists_day numeric(18,0)
-- số dư cuối
declare @v_last_so_du numeric(18,3)
declare @v_last_so_du_kha_dung numeric(18,3)
-- Set là câu lệnh gán giá trị, kiểm tra trong kho với mã hàng tương ứng, ngày đó đã có cập nhật số lượng hay chưa?
set @v_is_exists_day = (select count(1)  
                        FROM GD_SO_DU_TRAI_PHIEU gsdtp
                        WHERE gsdtp.NGAY = @date
							AND gsdtp.ID_TRAI_CHU = @ip_dc_trai_chu_id)
BEGIN TRANSACTION tran_cap_nhat_so_du						
--1. Neu khong co' ban ghi(tại ngày đó) thi phai tao 1 ban ghi tai ngay do'
if @v_is_exists_day = 0
BEGIN
	INSERT INTO GD_SO_DU_TRAI_PHIEU
	(
		-- ID -- this column value is auto-generated,
		ID_TRAI_CHU,
		NGAY,
		TONG_SO_DU,
		SO_DU_KHA_DUNG
	)
	VALUES
	(
		/* ID_TRAI_CHU	*/@ip_dc_trai_chu_id,
		/* NGAY	*/@date,
		/* TONG_SO_DU	*/0,
		/* SO_DU_KHA_DUNG	*/0
	)
-- Lay so du cua ngay truoc do' de cap nhat vao bang do' 
		select top(1) @v_last_so_du = gsdtp.TONG_SO_DU,
		 @v_last_so_du_kha_dung= gsdtp.SO_DU_KHA_DUNG
		FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.NGAY < @date
		AND gsdtp.ID_TRAI_CHU = @ip_dc_trai_chu_id
		order BY gsdtp.NGAY desc
-- 1.1 Nếu chưa có số dư đầu (chưa có ngày giao dịch nào cho tới ngày @date) thì
	if @v_last_so_du is null
		BEGIN
			set @v_last_so_du = 0  -- cho số dư cuối bằng 0	
			SET @v_last_so_du_kha_dung = 0  -- cho số dư khả dụng cuối bằng 0	
		END
-- Cập nhật lại số dư
	UPDATE GD_SO_DU_TRAI_PHIEU
	SET
		TONG_SO_DU = @v_last_so_du,
		SO_DU_KHA_DUNG = @v_last_so_du_kha_dung
	WHERE NGAY = @date
		AND ID_TRAI_CHU = @ip_dc_trai_chu_id
end
--2. Cap nhat so du tai khoan them vao
UPDATE GD_SO_DU_TRAI_PHIEU
SET	
	TONG_SO_DU = TONG_SO_DU + @add_value_tong_so_du,
	SO_DU_KHA_DUNG = SO_DU_KHA_DUNG + @add_value_so_du_kha_dung
WHERE NGAY >= @date
	AND ID_TRAI_CHU = @ip_dc_trai_chu_id
IF @@ERROR != 0 ROLLBACK TRAN tran_cap_nhat_so_du
ELSE COMMIT TRAN tran_cap_nhat_so_du

GO
CREATE PROC pr_GD_LICH_THANH_TOAN_LAI_GOC_Them_Ghi_Chu
@ID DECIMAL,
@GHI_CHU NVARCHAR(500)
AS
UPDATE GD_LICH_THANH_TOAN_LAI_GOC
SET
	GHI_CHU = @GHI_CHU
WHERE ID = @ID
GO

-- Hàm này dùng để tính số dư khả dụng trái phiếu dựa vào trái chủ và ngày
-- Input: ID_TRAI_CHU và NGAY truy vấn
-- Output: Số dư trái khả dụng phiếu tại ngày đó

CREATE FUNCTION f_so_du_kha_dung_trai_phieu_theo_trai_chu
(@ID_TRAI_CHU DECIMAL,
@NGAY DATETIME)
RETURNS NUMERIC(18,0)
AS
BEGIN
	-- Nếu ngày là 1/1/1900 thì lấy số dư hiện tại
	DECLARE @v_dc_so_du_kha_dung NUMERIC(18,0)
	IF ( @NGAY = '1/1/1900')
		SET @v_dc_so_du_kha_dung = (SELECT top 1 gsdtp.SO_DU_KHA_DUNG
		                     FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		ORDER BY gsdtp.NGAY DESC)
	
	-- Nếu ngày khác thì sẽ tính theo ngày
	ELSE
		SET @v_dc_so_du_kha_dung = (SELECT top 1 gsdtp.SO_DU_KHA_DUNG
		                     FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		AND gsdtp.NGAY = @NGAY)
	
	IF (@v_dc_so_du_kha_dung IS NULL) SET @v_dc_so_du_kha_dung = 0
	
	RETURN @v_dc_so_du_kha_dung
END

----
GO

-- Hàm này dùng để tính số dư trái phiếu dựa vào trái chủ và ngày
-- Input: ID_TRAI_CHU và NGAY truy vấn
-- Output: Số dư trái phiếu tại ngày đó

CREATE FUNCTION [dbo].[f_so_du_trai_phieu_theo_trai_chu]
(@ID_TRAI_CHU DECIMAL,
@NGAY DATETIME)
RETURNS NUMERIC(18,0)
AS
BEGIN
	-- Nếu ngày là 1/1/1900 thì lấy số dư hiện tại
	DECLARE @v_dc_so_du NUMERIC(18,0)
	IF ( @NGAY = '1/1/1900')
		SET @v_dc_so_du = (SELECT top 1 gsdtp.TONG_SO_DU FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		ORDER BY gsdtp.NGAY DESC)
	
	-- Nếu ngày khác thì sẽ tính theo ngày
	ELSE
		SET @v_dc_so_du = (SELECT top 1 gsdtp.TONG_SO_DU FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		AND gsdtp.NGAY = @NGAY)
	
	IF (@v_dc_so_du IS NULL) SET @v_dc_so_du = 0
	
	RETURN @v_dc_so_du
END

------ CREATE VIEW
GO
CREATE VIEW [dbo].[V_DM_TRAI_CHU]
AS
SELECT
	dtc.ID,MA_TRAI_CHU,TEN_TRAI_CHU,DIA_CHI,MOBILE,FAX,CMT_GIAY_DKKD,NGAY_CAP_CMT,NOI_CAP_CMT,
	ID_LOAI_TRAI_CHU,(SELECT cdtd.TEN FROM CM_DM_TU_DIEN cdtd
	                  WHERE cdtd.ID_LOAI_TU_DIEN = 3 AND cdtd.ID = dtc.ID_LOAI_TRAI_CHU) AS TEN_LOAI_TRAI_CHU,
	SO_TAI_KHOAN,
	MO_TAI_NGAN_HANG,
	GHI_CHU1,
	GHI_CHU2,
	GHI_CHU3,
	ID_TRAI_PHIEU_SO_HUU,dtp.TEN_TRAI_PHIEU,dbo.f_so_du_trai_phieu_theo_trai_chu(dtc.ID,'1/1/1900') AS TONG_SO_DU_TRAI_PHIEU,
	dbo.f_so_du_kha_dung_trai_phieu_theo_trai_chu(dtc.ID,'1/1/1900') AS SO_DU_KHA_DUNG,
	ID_NGUOI_LAP,
	ID_NGUOI_DUYET,
	ID_TRANG_THAI, (SELECT cdtd.TEN FROM CM_DM_TU_DIEN cdtd
	                WHERE dtc.ID_TRANG_THAI = cdtd.ID AND cdtd.ID_LOAI_TU_DIEN = 6) AS TEN_TRANG_THAI
FROM DM_TRAI_CHU dtc, DM_TRAI_PHIEU dtp
WHERE dtc.ID_TRAI_PHIEU_SO_HUU = dtp.ID

GO
--
CREATE PROCEDURE [dbo].[pr_V_DM_TRAI_CHU_Delete]
	@ID numeric(18, 0)
AS
DELETE FROM [dbo].[DM_TRAI_CHU]
WHERE
	[ID] = @ID

-----
GO
CREATE PROCEDURE [dbo].[pr_V_DM_TRAI_CHU_Update]
	@ID numeric(18, 0),
	@MA_TRAI_CHU nvarchar(35),
	@TEN_TRAI_CHU nvarchar(250),
	@DIA_CHI nvarchar(250),
	@MOBILE nvarchar(250),
	@FAX nvarchar(250),
	@CMT_GIAY_DKKD nvarchar(250),
	@NGAY_CAP_CMT datetime,
	@NOI_CAP_CMT nvarchar(50),
	@ID_LOAI_TRAI_CHU numeric(18, 0),
	@TEN_LOAI_TRAI_CHU NVARCHAR(250),
	@SO_TAI_KHOAN nvarchar(250),
	@MO_TAI_NGAN_HANG nvarchar(250),
	@GHI_CHU1 nvarchar(250),
	@GHI_CHU2 nvarchar(250),
	@GHI_CHU3 nvarchar(250),
	@ID_TRAI_PHIEU_SO_HUU numeric(18, 0),
	@TEN_TRAI_PHIEU NVARCHAR(250),
	@TONG_SO_DU_TRAI_PHIEU NUMERIC(18,0),
	@SO_DU_KHA_DUNG NUMERIC(18,0),
	@ID_NGUOI_LAP numeric(18, 0),
	@ID_NGUOI_DUYET numeric(18, 0),
	@ID_TRANG_THAI numeric(18, 0),
	@TEN_TRANG_THAI NVARCHAR(250)
AS
UPDATE [dbo].[DM_TRAI_CHU]
SET 
	[MA_TRAI_CHU] = @MA_TRAI_CHU,
	[TEN_TRAI_CHU] = @TEN_TRAI_CHU,
	[DIA_CHI] = @DIA_CHI,
	[MOBILE] = @MOBILE,
	[FAX] = @FAX,
	[CMT_GIAY_DKKD] = @CMT_GIAY_DKKD,
	[NGAY_CAP_CMT] = @NGAY_CAP_CMT,
	[NOI_CAP_CMT] = @NOI_CAP_CMT,
	[ID_LOAI_TRAI_CHU] = @ID_LOAI_TRAI_CHU,
	[SO_TAI_KHOAN] = @SO_TAI_KHOAN,
	[MO_TAI_NGAN_HANG] = @MO_TAI_NGAN_HANG,
	[GHI_CHU1] = @GHI_CHU1,
	[GHI_CHU2] = @GHI_CHU2,
	[GHI_CHU3] = @GHI_CHU3,
	[ID_TRAI_PHIEU_SO_HUU] = @ID_TRAI_PHIEU_SO_HUU,
	[ID_NGUOI_LAP] = @ID_NGUOI_LAP,
	[ID_NGUOI_DUYET] = @ID_NGUOI_DUYET,
	[ID_TRANG_THAI] = @ID_TRANG_THAI
WHERE
	[ID] = @ID

-----
GO
CREATE PROCEDURE pr_V_DM_TRAI_CHU_Insert
	@MA_TRAI_CHU nvarchar(35),
	@TEN_TRAI_CHU nvarchar(250),
	@DIA_CHI nvarchar(250),
	@MOBILE nvarchar(250),
	@FAX nvarchar(250),
	@CMT_GIAY_DKKD nvarchar(250),
	@NGAY_CAP_CMT datetime,
	@NOI_CAP_CMT nvarchar(50),
	@ID_LOAI_TRAI_CHU numeric(18, 0),
	@TEN_LOAI_TRAI_CHU NVARCHAR(250),
	@SO_TAI_KHOAN nvarchar(250),
	@MO_TAI_NGAN_HANG nvarchar(250),
	@GHI_CHU1 nvarchar(250),
	@GHI_CHU2 nvarchar(250),
	@GHI_CHU3 nvarchar(250),
	@ID_TRAI_PHIEU_SO_HUU numeric(18, 0),
	@TEN_TRAI_PHIEU NVARCHAR(250),
	@TONG_SO_DU_TRAI_PHIEU NUMERIC(18,0),
	@SO_DU_KHA_DUNG NUMERIC(18,0),
	@ID_NGUOI_LAP numeric(18, 0),
	@ID_NGUOI_DUYET numeric(18, 0),
	@ID_TRANG_THAI numeric(18, 0),
	@TEN_TRANG_THAI NVARCHAR(250),
	@ID numeric(18, 0) OUTPUT
AS
INSERT [dbo].[DM_TRAI_CHU]
(
	[MA_TRAI_CHU],
	[TEN_TRAI_CHU],
	[DIA_CHI],
	[MOBILE],
	[FAX],
	[CMT_GIAY_DKKD],
	[NGAY_CAP_CMT],
	[NOI_CAP_CMT],
	[ID_LOAI_TRAI_CHU],
	[SO_TAI_KHOAN],
	[MO_TAI_NGAN_HANG],
	[GHI_CHU1],
	[GHI_CHU2],
	[GHI_CHU3],
	[ID_TRAI_PHIEU_SO_HUU],
	[ID_NGUOI_LAP],
	[ID_NGUOI_DUYET],
	[ID_TRANG_THAI]
)
VALUES
(
	@MA_TRAI_CHU,
	@TEN_TRAI_CHU,
	@DIA_CHI,
	@MOBILE,
	@FAX,
	@CMT_GIAY_DKKD,
	@NGAY_CAP_CMT,
	@NOI_CAP_CMT,
	@ID_LOAI_TRAI_CHU,
	@SO_TAI_KHOAN,
	@MO_TAI_NGAN_HANG,
	@GHI_CHU1,
	@GHI_CHU2,
	@GHI_CHU3,
	@ID_TRAI_PHIEU_SO_HUU,
	@ID_NGUOI_LAP,
	@ID_NGUOI_DUYET,
	@ID_TRANG_THAI
)
SELECT @ID=SCOPE_IDENTITY()

----
GO
CREATE PROCEDURE [dbo].[pr_V_DM_TRAI_PHIEU_Delete]
	@ID numeric(18, 0)
AS
DELETE FROM [dbo].[DM_TRAI_PHIEU]
WHERE
	[ID] = @ID
---
GO
CREATE PROCEDURE [dbo].[pr_V_DM_TRAI_PHIEU_Insert]
	@ID_TO_CHUC_PHAT_HANH numeric(18, 0),
	@TEN_TO_CHUC_PHAT_HANH NVARCHAR(250),
	@MA_TRAI_PHIEU nvarchar(35),
	@TEN_TRAI_PHIEU nvarchar(250),
	@ID_LOAI_TRAI_PHIEU numeric(18, 0),
	@TEN_LOAI_TRAI_PHIEU NVARCHAR(250),
	@MENH_GIA numeric(21, 3),
	@KY_HAN numeric(4, 0),
	@ID_DV_KY_HAN numeric(18, 0),
	@DON_VI_KY_HAN NVARCHAR(50),
	@LAI_SUAT_DEFAULT numeric(21, 3),
	@KY_DIEU_CHINH_LS numeric(4, 0),
	@ID_DV_DIEU_CHINH_LS numeric(18, 0),
	@DON_VI_DIEU_CHINH_LAI_SUAT NVARCHAR(50),
	@THA_NOI_YN nvarchar(1),
	@KY_TRA_LAI numeric(4, 0),
	@ID_DV_KY_TRA_LAI numeric(18, 0),
	@DON_VI_KY_TRA_LAI NVARCHAR(50),
	@TRA_LAI_SAU_YN nvarchar(1),
	@NGAY_PHAT_HANH datetime,
	@NGAY_DAO_HAN datetime,
	@TONG_SL_PHAT_HANH numeric(18, 0),
	@TONG_GIA_TRI numeric(21, 3),
	@ID numeric(18, 0) OUTPUT
AS
INSERT [dbo].[DM_TRAI_PHIEU]
(
	[ID_TO_CHUC_PHAT_HANH],
	[MA_TRAI_PHIEU],
	[TEN_TRAI_PHIEU],
	[ID_LOAI_TRAI_PHIEU],
	[MENH_GIA],
	[KY_HAN],
	[ID_DV_KY_HAN],
	[LAI_SUAT_DEFAULT],
	[KY_DIEU_CHINH_LS],
	[ID_DV_DIEU_CHINH_LS],
	[THA_NOI_YN],
	[KY_TRA_LAI],
	[ID_DV_KY_TRA_LAI],
	[TRA_LAI_SAU_YN],
	[NGAY_PHAT_HANH],
	[NGAY_DAO_HAN],
	[TONG_SL_PHAT_HANH],
	[TONG_GIA_TRI]
)
VALUES
(
	@ID_TO_CHUC_PHAT_HANH,
	@MA_TRAI_PHIEU,
	@TEN_TRAI_PHIEU,
	@ID_LOAI_TRAI_PHIEU,
	@MENH_GIA,
	@KY_HAN,
	@ID_DV_KY_HAN,
	@LAI_SUAT_DEFAULT,
	@KY_DIEU_CHINH_LS,
	@ID_DV_DIEU_CHINH_LS,
	@THA_NOI_YN,
	@KY_TRA_LAI,
	@ID_DV_KY_TRA_LAI,
	@TRA_LAI_SAU_YN,
	@NGAY_PHAT_HANH,
	@NGAY_DAO_HAN,
	@TONG_SL_PHAT_HANH,
	@TONG_GIA_TRI
)
SELECT @ID=SCOPE_IDENTITY()


---
GO
CREATE PROCEDURE [dbo].[pr_V_DM_TRAI_PHIEU_Update]
	@ID numeric(18, 0),
	@ID_TO_CHUC_PHAT_HANH numeric(18, 0),
	@TEN_TO_CHUC_PHAT_HANH NVARCHAR(250),
	@MA_TRAI_PHIEU nvarchar(35),
	@TEN_TRAI_PHIEU nvarchar(250),
	@ID_LOAI_TRAI_PHIEU numeric(18, 0),
	@TEN_LOAI_TRAI_PHIEU NVARCHAR(250),
	@MENH_GIA numeric(21, 3),
	@KY_HAN numeric(4, 0),
	@ID_DV_KY_HAN numeric(18, 0),
	@DON_VI_KY_HAN NVARCHAR(50),
	@LAI_SUAT_DEFAULT numeric(21, 3),
	@KY_DIEU_CHINH_LS numeric(4, 0),
	@ID_DV_DIEU_CHINH_LS numeric(18, 0),
	@DON_VI_DIEU_CHINH_LAI_SUAT NVARCHAR(50),
	@THA_NOI_YN nvarchar(1),
	@KY_TRA_LAI numeric(4, 0),
	@ID_DV_KY_TRA_LAI numeric(18, 0),
	@DON_VI_KY_TRA_LAI NVARCHAR(50),
	@TRA_LAI_SAU_YN nvarchar(1),
	@NGAY_PHAT_HANH datetime,
	@NGAY_DAO_HAN datetime,
	@TONG_SL_PHAT_HANH numeric(18, 0),
	@TONG_GIA_TRI numeric(21, 3)
AS
UPDATE [dbo].[DM_TRAI_PHIEU]
SET 
	[ID_TO_CHUC_PHAT_HANH] = @ID_TO_CHUC_PHAT_HANH,
	[MA_TRAI_PHIEU] = @MA_TRAI_PHIEU,
	[TEN_TRAI_PHIEU] = @TEN_TRAI_PHIEU,
	[ID_LOAI_TRAI_PHIEU] = @ID_LOAI_TRAI_PHIEU,
	[MENH_GIA] = @MENH_GIA,
	[KY_HAN] = @KY_HAN,
	[ID_DV_KY_HAN] = @ID_DV_KY_HAN,
	[LAI_SUAT_DEFAULT] = @LAI_SUAT_DEFAULT,
	[KY_DIEU_CHINH_LS] = @KY_DIEU_CHINH_LS,
	[ID_DV_DIEU_CHINH_LS] = @ID_DV_DIEU_CHINH_LS,
	[THA_NOI_YN] = @THA_NOI_YN,
	[KY_TRA_LAI] = @KY_TRA_LAI,
	[ID_DV_KY_TRA_LAI] = @ID_DV_KY_TRA_LAI,
	[TRA_LAI_SAU_YN] = @TRA_LAI_SAU_YN,
	[NGAY_PHAT_HANH] = @NGAY_PHAT_HANH,
	[NGAY_DAO_HAN] = @NGAY_DAO_HAN,
	[TONG_SL_PHAT_HANH] = @TONG_SL_PHAT_HANH,
	[TONG_GIA_TRI] = @TONG_GIA_TRI
WHERE
	[ID] = @ID
-- 
GO
CREATE PROCEDURE pr_V_GD_PHONG_GIAI_TOAN_fill_data_by_date_and_to_chuc_phat_hanh
@TU_NGAY DATETIME
, @DEN_NGAY DATETIME
, @ID_TO_CHUC_PHAT_HANH DECIMAL
, @PHONG_TOA_YN NVARCHAR(1)
AS
SELECT * FROM V_GD_PHONG_GIAI_TOA vgpgt
WHERE (vgpgt.ID_TO_CHUC_PHAT_HANH = @ID_TO_CHUC_PHAT_HANH OR @ID_TO_CHUC_PHAT_HANH = 0)
AND vgpgt.NGAY_GIAO_DICH >= @TU_NGAY
AND vgpgt.NGAY_GIAO_DICH <= @DEN_NGAY
AND vgpgt.PHONG_TOA_YN = @PHONG_TOA_YN

--- Ngày 09/10/2012
CREATE VIEW [dbo].[V_GD_PHONG_GIAI_TOA]
as
SELECT
 gpgt.ID,dtp.MA_TRAI_PHIEU AS MA_GIAO_DICH
 , ID_TRAI_CHU,dtc.MA_TRAI_CHU, dtc.TEN_TRAI_CHU, dtc.CMT_GIAY_DKKD
 , dtc.NGAY_CAP_CMT, dtc.NOI_CAP_CMT
 , NGAY_GIAO_DICH,NGUOI_DAI_DIEN
 , gpgt.SO_LUONG, dtp.MENH_GIA,(gpgt.SO_LUONG * dtp.MENH_GIA) AS GIA_TRI_GD_THEO_MENH_GIA 
 , CHUC_DANH,PHONG_TOA_YN,gpgt.ID_NGUOI_LAP, hnsd.TEN AS NGUOI_THUC_HIEN
 , gpgt.ID_NGUOI_DUYET,  gpgt.ID_TRANG_THAI
 , TY_LE_PHI_GD,PHI_GIAO_DICH
 , dtp.ID_TO_CHUC_PHAT_HANH
FROM GD_PHONG_GIAI_TOA gpgt, DM_TRAI_CHU dtc, HT_NGUOI_SU_DUNG hnsd, DM_TRAI_PHIEU dtp
WHERE gpgt.ID_TRAI_CHU = dtc.ID
AND gpgt.ID_NGUOI_LAP = hnsd.ID
AND dtc.ID_TRAI_PHIEU_SO_HUU = dtp.ID
-- 
GO

CREATE PROCEDURE pr_DM_THAM_SO_NHAC_VIEC_cap_nhat_tham_so_nhac_viec
@NGAY_THANH_TOAN_LAI DECIMAL
, @NGAY_THANH_TOAN_GOC DECIMAL
, @NGAY_CAP_NHAT_LS DECIMAL
, @NGAY_CHOT_DS_LAI DECIMAL
AS
UPDATE DM_THAM_SO_NHAC_VIEC
SET
	SO_NGAY_NHAC_TRUOC = @NGAY_THANH_TOAN_LAI
WHERE ID_LOAI_NHAC_VIEC = 27 -- thanh toan lai

UPDATE DM_THAM_SO_NHAC_VIEC
SET
	SO_NGAY_NHAC_TRUOC = @NGAY_THANH_TOAN_GOC
WHERE ID_LOAI_NHAC_VIEC = 28 -- thanh toan goc

UPDATE DM_THAM_SO_NHAC_VIEC
SET
	SO_NGAY_NHAC_TRUOC = @NGAY_CAP_NHAT_LS
WHERE ID_LOAI_NHAC_VIEC = 29 -- thanh toan lai

UPDATE DM_THAM_SO_NHAC_VIEC
SET
	SO_NGAY_NHAC_TRUOC = @NGAY_CHOT_DS_LAI
WHERE ID_LOAI_NHAC_VIEC = 33 -- thanh toan lai