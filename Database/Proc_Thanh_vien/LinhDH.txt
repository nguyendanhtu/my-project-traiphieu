-- 1. Ý nghĩa: Procedure này dùng để cập nhật lại số dư và số dư khả dụng của trái phiếu
-- 2. Inputs: 
--   + @date: ngày cập nhật
--   + @ip_dc_trai_chu_id: id trái chủ (sẽ suy ra được id trái phiếu) cập nhật số dư trái phiếu
--   + @add_value_tong_so_du: Tổng số dư cập nhật. Nếu mà tổng số dư giảm thì số này là âm
--   + @add_value_so_du_kha_dung: Tổng số dư khả dụng cập nhật. Nếu mà số dư khả dụng giảm thì số này là âm
-- Trong trường hợp số dư khả dụng không đổi mà tổng số dư thay đổi 
-- thì số dư khả dụng sẽ thay đổi theo Tổng số dư

ALTER PROCEDURE [dbo].[pr_GD_SO_DU_TRAI_PHIEU_add_so_du]
  @date datetime
, @ip_dc_trai_chu_id numeric(18,0)
, @add_value_tong_so_du numeric(18,3)
, @add_value_so_du_kha_dung numeric(18,3)
AS
-- Biến này lưu trữ giá trị đúng (=1)or sai(=0): ngày cập nhật số lượng đã tồn tại hay chưa?
declare @v_is_exists_day numeric(18,0)
-- số dư cuối
declare @v_last_so_du numeric(18,3)
declare @v_last_so_du_kha_dung numeric(18,3)
-- Set là câu lệnh gán giá trị, kiểm tra trong kho với mã hàng tương ứng, ngày đó đã có cập nhật số lượng hay chưa?
set @v_is_exists_day = (select count(1)  
                        FROM GD_SO_DU_TRAI_PHIEU gsdtp
                        WHERE gsdtp.NGAY = @date
							AND gsdtp.ID_TRAI_CHU = @ip_dc_trai_chu_id)
BEGIN TRANSACTION tran_cap_nhat_so_du						
--1. Neu khong co' ban ghi(tại ngày đó) thi phai tao 1 ban ghi tai ngay do'
if @v_is_exists_day = 0
BEGIN
	INSERT INTO GD_SO_DU_TRAI_PHIEU
	(
		-- ID -- this column value is auto-generated,
		ID_TRAI_CHU,
		NGAY,
		TONG_SO_DU,
		SO_DU_KHA_DUNG
	)
	VALUES
	(
		/* ID_TRAI_CHU	*/@ip_dc_trai_chu_id,
		/* NGAY	*/@date,
		/* TONG_SO_DU	*/0,
		/* SO_DU_KHA_DUNG	*/0
	)
-- Lay so du cua ngay truoc do' de cap nhat vao bang do' 
		select top(1) @v_last_so_du = gsdtp.TONG_SO_DU,
		 @v_last_so_du_kha_dung= gsdtp.SO_DU_KHA_DUNG
		FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.NGAY < @date
		AND gsdtp.ID_TRAI_CHU = @ip_dc_trai_chu_id
		order BY gsdtp.NGAY desc
-- 1.1 Nếu chưa có số dư đầu (chưa có ngày giao dịch nào cho tới ngày @date) thì
	if @v_last_so_du is null
		BEGIN
			set @v_last_so_du = 0  -- cho số dư cuối bằng 0	
			SET @v_last_so_du_kha_dung = 0  -- cho số dư khả dụng cuối bằng 0	
		END
-- Cập nhật lại số dư
	UPDATE GD_SO_DU_TRAI_PHIEU
	SET
		TONG_SO_DU = @v_last_so_du,
		SO_DU_KHA_DUNG = @v_last_so_du_kha_dung
	WHERE NGAY = @date
		AND ID_TRAI_CHU = @ip_dc_trai_chu_id
end
--2. Cap nhat so du tai khoan them vao
UPDATE GD_SO_DU_TRAI_PHIEU
SET	
	TONG_SO_DU = TONG_SO_DU + @add_value_tong_so_du,
	SO_DU_KHA_DUNG = SO_DU_KHA_DUNG + @add_value_so_du_kha_dung
WHERE NGAY >= @date
	AND ID_TRAI_CHU = @ip_dc_trai_chu_id
IF @@ERROR != 0 ROLLBACK TRAN tran_cap_nhat_so_du
ELSE COMMIT TRAN tran_cap_nhat_so_du

GO
CREATE PROC pr_GD_LICH_THANH_TOAN_LAI_GOC_Them_Ghi_Chu
@ID DECIMAL,
@GHI_CHU NVARCHAR(500)
AS
UPDATE GD_LICH_THANH_TOAN_LAI_GOC
SET
	GHI_CHU = @GHI_CHU
WHERE ID = @ID
GO

-- Hàm này dùng để tính số dư khả dụng trái phiếu dựa vào trái chủ và ngày
-- Input: ID_TRAI_CHU và NGAY truy vấn
-- Output: Số dư trái khả dụng phiếu tại ngày đó

CREATE FUNCTION f_so_du_kha_dung_trai_phieu_theo_trai_chu
(@ID_TRAI_CHU DECIMAL,
@NGAY DATETIME)
RETURNS NUMERIC(18,0)
AS
BEGIN
	-- Nếu ngày là 1/1/1900 thì lấy số dư hiện tại
	DECLARE @v_dc_so_du_kha_dung NUMERIC(18,0)
	IF ( @NGAY = '1/1/1900')
		SET @v_dc_so_du_kha_dung = (SELECT top 1 gsdtp.SO_DU_KHA_DUNG
		                     FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		ORDER BY gsdtp.NGAY DESC)
	
	-- Nếu ngày khác thì sẽ tính theo ngày
	ELSE
		SET @v_dc_so_du_kha_dung = (SELECT top 1 gsdtp.SO_DU_KHA_DUNG
		                     FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		AND gsdtp.NGAY = @NGAY)
	
	IF (@v_dc_so_du_kha_dung IS NULL) SET @v_dc_so_du_kha_dung = 0
	
	RETURN @v_dc_so_du_kha_dung
END

----
GO

-- Hàm này dùng để tính số dư trái phiếu dựa vào trái chủ và ngày
-- Input: ID_TRAI_CHU và NGAY truy vấn
-- Output: Số dư trái phiếu tại ngày đó

CREATE FUNCTION [dbo].[f_so_du_trai_phieu_theo_trai_chu]
(@ID_TRAI_CHU DECIMAL,
@NGAY DATETIME)
RETURNS NUMERIC(18,0)
AS
BEGIN
	-- Nếu ngày là 1/1/1900 thì lấy số dư hiện tại
	DECLARE @v_dc_so_du NUMERIC(18,0)
	IF ( @NGAY = '1/1/1900')
		SET @v_dc_so_du = (SELECT top 1 gsdtp.TONG_SO_DU FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		ORDER BY gsdtp.NGAY DESC)
	
	-- Nếu ngày khác thì sẽ tính theo ngày
	ELSE
		SET @v_dc_so_du = (SELECT top 1 gsdtp.TONG_SO_DU FROM GD_SO_DU_TRAI_PHIEU gsdtp
		WHERE gsdtp.ID_TRAI_CHU = @ID_TRAI_CHU
		AND gsdtp.NGAY = @NGAY)
	
	IF (@v_dc_so_du IS NULL) SET @v_dc_so_du = 0
	
	RETURN @v_dc_so_du
END

------ CREATE VIEW
GO
CREATE VIEW [dbo].[V_DM_TRAI_CHU]
AS
SELECT
	dtc.ID,MA_TRAI_CHU,TEN_TRAI_CHU,DIA_CHI,MOBILE,FAX,CMT_GIAY_DKKD,NGAY_CAP_CMT,NOI_CAP_CMT,
	ID_LOAI_TRAI_CHU,(SELECT cdtd.TEN FROM CM_DM_TU_DIEN cdtd
	                  WHERE cdtd.ID_LOAI_TU_DIEN = 3 AND cdtd.ID = dtc.ID_LOAI_TRAI_CHU) AS TEN_LOAI_TRAI_CHU,
	SO_TAI_KHOAN,
	MO_TAI_NGAN_HANG,
	GHI_CHU1,
	GHI_CHU2,
	GHI_CHU3,
	ID_TRAI_PHIEU_SO_HUU,dtp.TEN_TRAI_PHIEU,dbo.f_so_du_trai_phieu_theo_trai_chu(dtc.ID,'1/1/1900') AS TONG_SO_DU_TRAI_PHIEU,
	dbo.f_so_du_kha_dung_trai_phieu_theo_trai_chu(dtc.ID,'1/1/1900') AS SO_DU_KHA_DUNG,
	ID_NGUOI_LAP,
	ID_NGUOI_DUYET,
	ID_TRANG_THAI, (SELECT cdtd.TEN FROM CM_DM_TU_DIEN cdtd
	                WHERE dtc.ID_TRANG_THAI = cdtd.ID AND cdtd.ID_LOAI_TU_DIEN = 6) AS TEN_TRANG_THAI
FROM DM_TRAI_CHU dtc, DM_TRAI_PHIEU dtp
WHERE dtc.ID_TRAI_PHIEU_SO_HUU = dtp.ID